# .github/workflows/sync-pointfree-docs.yml
name: Sync Point-Free Documentation

on:
    workflow_dispatch: # manual trigger
    schedule:
        - cron: "0 6 * * *" # daily at 6:00 UTC

jobs:
    check-and-sync:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout docs repo
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Check for updates and sync
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # define repositories to track
                  declare -A REPOS
                  REPOS["pointfreeco/swift-composable-architecture"]="Sources/ComposableArchitecture/Documentation.docc"
                  REPOS["pointfreeco/swift-navigation"]="Sources/AppKitNavigation/Documentation.docc,Sources/SwiftNavigation/Documentation.docc,Sources/SwiftUINavigation/Documentation.docc,Sources/UIKitNavigation/Documentation.docc"
                  REPOS["pointfreeco/swift-dependencies"]="Sources/Dependencies/Documentation.docc"
                  REPOS["pointfreeco/swift-case-paths"]="Sources/CasePaths/Documentation.docc,Sources/CasePathsCore/Documentation.docc"
                  REPOS["pointfreeco/sqlite-data"]="Sources/SQLiteData/Documentation.docc"

                  # load last sync state
                  SYNC_FILE=".last-sync.json"
                  if [ -f "$SYNC_FILE" ]; then
                    echo "ðŸ“‹ Loading previous sync state..."
                    LAST_SYNC=$(cat "$SYNC_FILE")
                  else
                    echo "ðŸ“‹ No previous sync state found, will sync all repos"
                    LAST_SYNC="{}"
                  fi

                  # check each repo for updates
                  REPOS_TO_UPDATE=""
                  NEW_SYNC="{}"

                  for repo in "${!REPOS[@]}"; do
                    echo "ðŸ” Checking $repo..."

                    # get latest commit SHA using GitHub API
                    LATEST_SHA=$(curl -s -H "Authorization: token $GH_TOKEN" \
                      "https://api.github.com/repos/$repo/commits/main" | \
                      jq -r '.sha // empty')

                    if [ -z "$LATEST_SHA" ]; then
                      echo "  âš ï¸  Could not fetch SHA for $repo, will sync anyway"
                      REPOS_TO_UPDATE="$REPOS_TO_UPDATE $repo"
                    else
                      # get last synced SHA
                      LAST_SHA=$(echo "$LAST_SYNC" | jq -r ".\"$repo\" // empty")

                      if [ "$LATEST_SHA" != "$LAST_SHA" ]; then
                        echo "  ðŸ“¦ Updates found! ($LAST_SHA -> $LATEST_SHA)"
                        REPOS_TO_UPDATE="$REPOS_TO_UPDATE $repo"
                      else
                        echo "  âœ… No changes"
                      fi
                    fi

                    # build new sync state
                    if [ -n "$LATEST_SHA" ]; then
                      NEW_SYNC=$(echo "$NEW_SYNC" | jq --arg repo "$repo" --arg sha "$LATEST_SHA" '. + {($repo): $sha}')
                    fi
                  done

                  # if no updates and not manual trigger, exit early
                  if [ -z "$REPOS_TO_UPDATE" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
                    echo ""
                    echo "ðŸŽ‰ All documentation is up to date! No sync needed."
                    exit 0
                  fi

                  # if manual trigger, sync all repos
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo ""
                    echo "ðŸ”§ Manual trigger detected, syncing all repos..."
                    REPOS_TO_UPDATE="${!REPOS[*]}"
                  fi

                  echo ""
                  echo "ðŸš€ Starting sync for:$REPOS_TO_UPDATE"
                  echo ""

                  # function to process a single repo
                  process_repo() {
                    local repo=$1
                    local paths=$2
                    local repo_name=$(echo "$repo" | cut -d'/' -f2)
                    local output_file="${repo_name}-docs.md"

                    echo "ðŸ”„ Processing $repo..."

                    # clone repo
                    if [ -d "temp-repo" ]; then
                      rm -rf temp-repo
                    fi
                    git clone "https://github.com/$repo.git" temp-repo --depth 1 --quiet

                    # start output file
                    echo "# $repo Documentation" > "$output_file"
                    echo "" >> "$output_file"
                    echo "Auto-generated from https://github.com/$repo" >> "$output_file"
                    echo "Generated on: $(date)" >> "$output_file"
                    echo "" >> "$output_file"

                    # process each path
                    IFS=',' read -ra PATH_ARRAY <<< "$paths"
                    for path in "${PATH_ARRAY[@]}"; do
                      # trim whitespace
                      path=$(echo "$path" | xargs)

                      if [ -d "temp-repo/$path" ]; then
                        echo "ðŸ“ Found docs at: $path"
                        echo "## Documentation from $path" >> "$output_file"
                        echo "" >> "$output_file"

                        # find and process all .md files
                        find "temp-repo/$path" -name "*.md" -type f | sort | while read -r file; do
                          filename=$(basename "$file" .md)
                          echo "  ðŸ“„ Processing: $filename.md"
                          echo "### $filename" >> "$output_file"
                          echo "" >> "$output_file"
                          cat "$file" >> "$output_file"
                          echo "" >> "$output_file"
                          echo "---" >> "$output_file"
                          echo "" >> "$output_file"
                        done
                      else
                        echo "âš ï¸  Path not found: $path"
                        echo "âš ï¸  Path not found: $path" >> "$output_file"
                        echo "" >> "$output_file"
                      fi
                    done

                    # cleanup temp repo
                    rm -rf temp-repo
                    echo "âœ… Generated: $output_file"
                    echo ""
                  }

                  # process only repos that need updating
                  for repo in $REPOS_TO_UPDATE; do
                    paths="${REPOS[$repo]}"
                    if [ -n "$paths" ]; then
                      process_repo "$repo" "$paths"
                    fi
                  done

                  # save new sync state
                  echo "$NEW_SYNC" | jq '.' > "$SYNC_FILE"
                  echo "ðŸ’¾ Saved sync state to $SYNC_FILE"

                  echo ""
                  echo "ðŸŽ‰ Sync complete!"

            - name: Commit and push changes
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"

                  # add all generated files and sync state
                  git add *.md .last-sync.json

                  # check if there are changes to commit
                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                  else
                    git commit -m "Update Point-Free documentation files"
                    git push
                  fi
